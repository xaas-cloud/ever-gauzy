name: Agent Build Test (x64/arm64)

on:
  workflow_dispatch:
  push:
    branches: [develop]

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  release-windows-arm64:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 150

    strategy:
      matrix:
        os: [windows-11-arm]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v6
        with:
          node-version: 24.13.0
          architecture: arm64

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        shell: bash
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-${{ runner.arch }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-yarn-

      - name: Install Visual Studio 2022 Build Tools (VCTools with ARM64)
        shell: powershell
        run: |
          choco install -y visualstudio2022buildtools --execution-timeout=21600 --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.Tools.ARM64 --includeRecommended --passive --norestart"

      - name: Configure node-gyp to use VS 2022
        shell: powershell
        run: |
          "GYP_MSVS_VERSION=2022" | Out-File -FilePath $env:GITHUB_ENV -Append
          "npm_config_msvs_version=2022" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Fix node-gyp and Python
        run: python3 -m pip install packaging setuptools

      - name: Setup MSVC (VS 2022 dev env)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Install latest version of NPM
        run: 'npm install -g npm@11.6.2'

      - name: Install globally node-gyp, ts-node and nx packages
        run: 'npm install --quiet -g node-gyp@10.2.0 ts-node@10.9.2 nx@20.8.0'

      - name: Configure npm python for node-gyp
        shell: powershell
        run: |
          $py = (Get-Command python.exe).Source
          Write-Host "python is: $py"
          "npm_config_python=$py" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PYTHON=$py"            | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Show tool versions
        shell: powershell
        run: |
          node -v
          npm -v
          python --version
          python -c "import sys; print(sys.executable)"

      - name: Install Yarn dependencies
        run: 'yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts'

      - name: Run Postinstall Manually
        run: 'yarn postinstall.manual'

      - name: Bump version agent app
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.scripts/bump-version-electron.js')
            console.log(script.agent(true))
        env:
          PROJECT_REPO: 'https://github.com/ever-co/ever-gauzy.git'
          AGENT_APP_NAME: 'gauzy-agent'
          AGENT_APP_REPO_NAME: 'ever-gauzy-agent'
          AGENT_APP_REPO_OWNER: 'ever-co'
          COMPANY_SITE_LINK: 'https://gauzy.co'
          AGENT_APP_DESCRIPTION: 'Gauzy Agent'
          AGENT_APP_ID: 'com.ever.gauzyagent'

      - name: Configure PATH for all child processes
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Get absolute paths
          $nodePath = (Get-Command node -ErrorAction Stop).Source | Split-Path -Parent
          $yarnCmd = Get-Command yarn -ErrorAction SilentlyContinue
          $yarnPath = if ($yarnCmd) { Split-Path $yarnCmd.Source -Parent } else { "" }
          $localBin = Join-Path $PWD "node_modules\.bin"
          $npmGlobalBin = & npm config get prefix

          Write-Host "Node path: $nodePath"
          Write-Host "Yarn path: $yarnPath"
          Write-Host "Local bin: $localBin"
          Write-Host "NPM global: $npmGlobalBin"

          # Build new PATH with all required directories at the front
          $newPath = "$nodePath;$yarnPath;$localBin;$npmGlobalBin;$($env:PATH)"

          # Set PATH via GITHUB_ENV - this affects ALL subsequent child processes
          "PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          # Also add individual paths to GITHUB_PATH for good measure
          $localBin | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          $npmGlobalBin | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          $yarnPath | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          $nodePath | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

          Write-Host "PATH configured for all child processes"

      - name: Build Agent
        shell: cmd
        run: |
          echo === Environment Diagnostics ===
          echo NODE location:
          where node
          echo.
          echo NODE architecture:
          node -p process.arch
          echo.
          echo YARN location:
          where yarn
          echo.
          echo TS-NODE location:
          where ts-node
          echo.
          echo CROSS-ENV location:
          where cross-env
          echo.
          echo NX location:
          where nx
          echo.
          echo === Full PATH ===
          echo %PATH%
          echo.
          echo === Starting build ===
          yarn build:agent:windows:release:gh:arm64
        env:
          USE_HARD_LINKS: false
          ELECTRON_BUILDER_CACHE: ${{ github.workspace }}\.cache\electron-builder
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          EP_GH_IGNORE_TIME: true
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_TRACES_SAMPLE_RATE: '${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}'
          SENTRY_PROFILE_SAMPLE_RATE: '${{ secrets.SENTRY_PROFILE_SAMPLE_RATE }}'
          SENTRY_HTTP_TRACING_ENABLED: '${{ secrets.SENTRY_HTTP_TRACING_ENABLED }}'
          SENTRY_POSTGRES_TRACKING_ENABLED: '${{ secrets.SENTRY_POSTGRES_TRACKING_ENABLED }}'
          SENTRY_PROFILING_ENABLED: '${{ secrets.SENTRY_PROFILING_ENABLED }}'
          DO_KEY_ID: ${{ secrets.DO_KEY_ID }}
          DO_SECRET_KEY: ${{ secrets.DO_SECRET_KEY }}
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
          NX_NO_CLOUD: true
