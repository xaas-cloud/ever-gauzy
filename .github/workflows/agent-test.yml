name: Agent Build Test (x64/arm64)

on:
  workflow_dispatch:
  push:
    branches: [develop]

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  release-windows-arm64:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 150

    strategy:
      matrix:
        os: [windows-11-arm]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js, NPM and Yarn
        uses: actions/setup-node@v6
        with:
          node-version: 24.13.0
          architecture: arm64

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        shell: bash
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-${{ runner.arch }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-yarn-

      - name: Install Visual Studio 2022 Build Tools (VCTools with ARM64)
        shell: powershell
        run: |
          choco install -y visualstudio2022buildtools --execution-timeout=21600 --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.Tools.ARM64 --includeRecommended --passive --norestart"

      - name: Configure node-gyp to use VS 2022
        shell: powershell
        run: |
          "GYP_MSVS_VERSION=2022" | Out-File -FilePath $env:GITHUB_ENV -Append
          "npm_config_msvs_version=2022" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Fix node-gyp and Python
        run: python3 -m pip install packaging setuptools

      - name: Setup MSVC (VS 2022 dev env)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Install latest version of NPM
        run: 'npm install -g npm@11.6.2'

      - name: Install globally node-gyp, ts-node and nx packages
        run: 'npm install --quiet -g node-gyp@10.2.0 ts-node@10.9.2 nx@20.8.0'

      - name: Configure npm python for node-gyp
        shell: powershell
        run: |
          $py = (Get-Command python.exe).Source
          Write-Host "python is: $py"
          "npm_config_python=$py" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PYTHON=$py"            | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Show tool versions
        shell: powershell
        run: |
          node -v
          npm -v
          python --version
          python -c "import sys; print(sys.executable)"

      - name: Install Yarn dependencies
        run: 'yarn install --network-timeout 1000000 --frozen-lockfile --ignore-scripts'

      - name: Run Postinstall Manually
        run: 'yarn postinstall.manual'

      - name: Bump version agent app
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.scripts/bump-version-electron.js')
            console.log(script.agent(true))
        env:
          PROJECT_REPO: 'https://github.com/ever-co/ever-gauzy.git'
          AGENT_APP_NAME: 'gauzy-agent'
          AGENT_APP_REPO_NAME: 'ever-gauzy-agent'
          AGENT_APP_REPO_OWNER: 'ever-co'
          COMPANY_SITE_LINK: 'https://gauzy.co'
          AGENT_APP_DESCRIPTION: 'Gauzy Agent'
          AGENT_APP_ID: 'com.ever.gauzyagent'

      - name: Fix Node.js PATH for child processes (Multiple Approaches)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "=========================================="
          Write-Host "FIXING NODE.JS PATH FOR CHILD PROCESSES"
          Write-Host "=========================================="

          # Get paths
          $nodeExe = (Get-Command node -ErrorAction Stop).Source
          $nodePath = Split-Path $nodeExe -Parent
          $npmGlobalBin = & npm config get prefix
          $localBin = Join-Path $PWD "node_modules\.bin"
          $yarnCmd = Get-Command yarn -ErrorAction SilentlyContinue
          $yarnPath = if ($yarnCmd) { Split-Path $yarnCmd.Source -Parent } else { "" }

          Write-Host "`n=== Current Paths ==="
          Write-Host "Node executable: $nodeExe"
          Write-Host "Node path: $nodePath"
          Write-Host "NPM global bin: $npmGlobalBin"
          Write-Host "Yarn path: $yarnPath"
          Write-Host "Local bin: $localBin"

          # ============================================
          # APPROACH 1: Copy node.exe to npm global bin
          # ============================================
          Write-Host "`n=== APPROACH 1: Copy node.exe to npm global bin ==="
          $npmNodeExe = Join-Path $npmGlobalBin "node.exe"
          if (-not (Test-Path $npmNodeExe)) {
            Write-Host "Copying node.exe to $npmNodeExe"
            Copy-Item $nodeExe $npmNodeExe -Force
          } else {
            Write-Host "node.exe already exists at $npmNodeExe"
          }

          # ============================================
          # APPROACH 2: Copy node.exe to local node_modules/.bin
          # ============================================
          Write-Host "`n=== APPROACH 2: Copy node.exe to local node_modules/.bin ==="
          $localNodeExe = Join-Path $localBin "node.exe"
          if (-not (Test-Path $localNodeExe)) {
            Write-Host "Copying node.exe to $localNodeExe"
            Copy-Item $nodeExe $localNodeExe -Force
          } else {
            Write-Host "node.exe already exists at $localNodeExe"
          }

          # ============================================
          # APPROACH 3: Set PATH via GITHUB_ENV (for next steps)
          # ============================================
          Write-Host "`n=== APPROACH 3: Set PATH via GITHUB_ENV ==="
          $newPath = "$nodePath;$npmGlobalBin;$localBin;$yarnPath;$($env:PATH)"
          "PATH=$newPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "PATH written to GITHUB_ENV"

          # ============================================
          # APPROACH 4: Set paths via GITHUB_PATH
          # ============================================
          Write-Host "`n=== APPROACH 4: Set paths via GITHUB_PATH ==="
          @($nodePath, $npmGlobalBin, $localBin, $yarnPath) | Where-Object { $_ } | ForEach-Object {
            $_ | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
            Write-Host "Added to GITHUB_PATH: $_"
          }

          # ============================================
          # APPROACH 5: Set NODE environment variable
          # ============================================
          Write-Host "`n=== APPROACH 5: Set NODE environment variable ==="
          "NODE=$nodeExe" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "NODE_PATH=$nodePath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "NODE=$nodeExe"
          Write-Host "NODE_PATH=$nodePath"

          # ============================================
          # APPROACH 6: Configure npm to prepend node path
          # ============================================
          Write-Host "`n=== APPROACH 6: Configure npm scripts-prepend-node-path ==="
          npm config set scripts-prepend-node-path true
          Write-Host "npm scripts-prepend-node-path = true"

          # ============================================
          # APPROACH 7: Update Process-level PATH immediately
          # ============================================
          Write-Host "`n=== APPROACH 7: Update process PATH immediately ==="
          $env:PATH = $newPath
          [System.Environment]::SetEnvironmentVariable("PATH", $newPath, "Process")
          Write-Host "Process PATH updated"

          # ============================================
          # VERIFICATION
          # ============================================
          Write-Host "`n=== VERIFICATION ==="
          Write-Host "NPM global node.exe exists: $(Test-Path $npmNodeExe)"
          Write-Host "Local bin node.exe exists: $(Test-Path $localNodeExe)"
          Write-Host "`nTesting node.exe from different locations:"
          Write-Host "From npm global bin:"
          & $npmNodeExe -p "process.arch + ' from ' + process.execPath"
          Write-Host "From local bin:"
          & $localNodeExe -p "process.arch + ' from ' + process.execPath"
          Write-Host "`nTesting cmd.exe visibility:"
          cmd /c "where node"
          cmd /c "node -p process.arch"

      - name: Quick Smoke Test (ui-config:setup-env)
        shell: cmd
        run: |
          echo === Environment Diagnostics ===
          echo NODE location:
          where node
          echo.
          echo NODE architecture:
          node -p process.arch
          echo.
          echo YARN location:
          where yarn
          echo.
          echo TS-NODE location:
          where ts-node
          echo.
          echo CROSS-ENV location:
          where cross-env
          echo.
          echo NX location:
          where nx
          echo.
          echo === Full PATH ===
          echo %PATH%
          echo.
          echo ==========================================
          echo RUNNING SMOKE TEST: ui-config:setup-env
          echo ==========================================
          yarn nx run ui-config:setup-env:production
          echo.
          echo ==========================================
          echo SMOKE TEST PASSED! PATH fix is working.
          echo ==========================================
        env:
          USE_HARD_LINKS: false
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
          NX_NO_CLOUD: true

      # Uncomment below to run full build after smoke test passes
      # - name: Build Agent
      #   shell: cmd
      #   run: yarn build:agent:windows:release:gh:arm64
      #   env:
      #     USE_HARD_LINKS: false
      #     ELECTRON_BUILDER_CACHE: ${{ github.workspace }}\.cache\electron-builder
      #     GH_TOKEN: ${{ secrets.GH_TOKEN }}
      #     EP_GH_IGNORE_TIME: true
      #     SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      #     SENTRY_TRACES_SAMPLE_RATE: '${{ secrets.SENTRY_TRACES_SAMPLE_RATE }}'
      #     SENTRY_PROFILE_SAMPLE_RATE: '${{ secrets.SENTRY_PROFILE_SAMPLE_RATE }}'
      #     SENTRY_HTTP_TRACING_ENABLED: '${{ secrets.SENTRY_HTTP_TRACING_ENABLED }}'
      #     SENTRY_POSTGRES_TRACKING_ENABLED: '${{ secrets.SENTRY_POSTGRES_TRACKING_ENABLED }}'
      #     SENTRY_PROFILING_ENABLED: '${{ secrets.SENTRY_PROFILING_ENABLED }}'
      #     DO_KEY_ID: ${{ secrets.DO_KEY_ID }}
      #     DO_SECRET_KEY: ${{ secrets.DO_SECRET_KEY }}
      #     NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
      #     NX_NO_CLOUD: true
