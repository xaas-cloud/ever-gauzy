<div class="dialog-container">
  <nb-card>
    <nb-card-header class="d-flex justify-content-between align-items-center">
      <div class="header-content">
        <div class="header-icon-container">
          <nb-icon icon="person-add-outline"></nb-icon>
        </div>
        <h5 class="mb-0">{{ 'PLUGIN.ASSIGNMENT_DIALOG.TITLE' | translate }}</h5>
      </div>
      <button nbButton ghost size="small" (click)="close()" [disabled]="loading$ | async" class="close-btn">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </nb-card-header>

    <nb-card-body>
      <form [formGroup]="form">
        <!-- User Selection -->
        <div class="form-group">
          <label class="label">
            <nb-icon icon="people-outline" class="label-icon"></nb-icon>
            {{ 'PLUGIN.ASSIGNMENT_DIALOG.SELECT_USERS' | translate }}
            <span class="text-danger">*</span>
          </label>

          <nb-select
            fullWidth
            multiple
            placeholder="{{ 'PLUGIN.ASSIGNMENT_DIALOG.SELECT_USERS_PLACEHOLDER' | translate }}"
            formControlName="userIds"
            [disabled]="loadingUsers || (loading$ | async)"
            >
            @for (user of availableUsers; track user) {
              <nb-option [value]="user.id">
                <div class="user-option">
                  <span class="user-name">{{ user.name || user.email }}</span>
                  @if (user.email) {
                    <span class="user-email text-muted">
                      {{ user.email }}
                    </span>
                  }
                </div>
              </nb-option>
            }
          </nb-select>

          @if (selectedCount > 0) {
            <div class="form-help-text">
              <nb-icon icon="checkmark-circle-2-outline" status="success"></nb-icon>
              {{ 'PLUGIN.ASSIGNMENT_DIALOG.SELECTED_COUNT' | translate : { count: selectedCount } }}
            </div>
          }

          @if (form.get('userIds')?.invalid && form.get('userIds')?.touched) {
            <div class="form-error">
              @if (form.get('userIds')?.errors?.['required']) {
                <span>
                  {{ 'PLUGIN.ASSIGNMENT_DIALOG.USERS_REQUIRED' | translate }}
                </span>
              }
            </div>
          }
        </div>

        <!-- Reason (Optional) -->
        <div class="form-group">
          <label class="label">
            <nb-icon icon="message-circle-outline" class="label-icon"></nb-icon>
            {{ 'PLUGIN.ASSIGNMENT_DIALOG.REASON' | translate }}
            <span class="text-muted">({{ 'PLUGIN.ASSIGNMENT_DIALOG.OPTIONAL' | translate }})</span>
          </label>

          <textarea
            nbInput
            fullWidth
            rows="3"
            placeholder="{{ 'PLUGIN.ASSIGNMENT_DIALOG.REASON_PLACEHOLDER' | translate }}"
            formControlName="reason"
            [disabled]="loading$ | async"
            >
          </textarea>

          <div class="form-help-text">
            <nb-icon icon="edit-outline" class="help-icon"></nb-icon>
            {{ form.get('reason')?.value?.length || 0 }} / 500
          </div>

          @if (form.get('reason')?.invalid && form.get('reason')?.touched) {
            <div class="form-error">
              @if (form.get('reason')?.errors?.['maxlength']) {
                <span>
                  {{ 'PLUGIN.ASSIGNMENT_DIALOG.REASON_TOO_LONG' | translate }}
                </span>
              }
            </div>
          }
        </div>

        <!-- Loading Indicator -->
        @if (loadingUsers) {
          <div class="loading-overlay">
            <nb-spinner status="primary"></nb-spinner>
            <span class="mt-2">{{ 'PLUGIN.ASSIGNMENT_DIALOG.LOADING_USERS' | translate }}</span>
          </div>
        }

        <!-- Error Message -->
        @if (error$ | async; as error) {
          <nb-alert status="danger" class="mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <span>{{ error }}</span>
              <button nbButton ghost size="tiny" (click)="accessFacade.resetError()">
                <nb-icon icon="close-outline"></nb-icon>
              </button>
            </div>
          </nb-alert>
        }
      </form>
    </nb-card-body>

    <nb-card-footer class="d-flex justify-content-between">
      <button nbButton status="basic" size="small" (click)="close()" [disabled]="loading$ | async">
        {{ 'BUTTONS.CANCEL' | translate }}
      </button>

      <button
        nbButton
        status="primary"
        size="small"
        (click)="assignUsers()"
        [disabled]="!isValid || (loading$ | async)"
        >
        @if (loading$ | async) {
          <nb-spinner size="tiny" status="control"></nb-spinner>
        }
        @if (!(loading$ | async)) {
          <nb-icon icon="person-add-outline" class="mr-1"></nb-icon>
        }
        {{ 'PLUGIN.ASSIGNMENT_DIALOG.ASSIGN_BUTTON' | translate }}
      </button>
    </nb-card-footer>
  </nb-card>
</div>
