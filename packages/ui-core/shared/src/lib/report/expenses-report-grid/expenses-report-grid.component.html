<div class="group-by-wrapper">
  <div class="label">
    {{ 'REPORT_PAGE.GROUP_BY' | translate }}
  </div>
  <div class="ml-3">
    <nb-select [(ngModel)]="groupBy" (selectedChange)="groupByChange()" optionsListClass="nb-options">
      <nb-option value="date">
        {{ 'REPORT_PAGE.DATE' | translate }}
      </nb-option>
      <nb-option value="employee">
        {{ 'REPORT_PAGE.EMPLOYEE' | translate }}
      </nb-option>
      <nb-option value="project">
        {{ 'REPORT_PAGE.PROJECT' | translate }}
      </nb-option>
    </nb-select>
  </div>
</div>
<div
  class="weekly-logs row-table expense-report-grid"
  [nbSpinner]="loading"
  [nbSpinnerSize]="'giant'"
  [nbSpinnerStatus]="'primary'"
  >
  <ng-template #columnsHeader>
    @if (dailyData?.length > 0) {
      <div class="columns-header">
        <div class="table-inner-wrapper font-weight-bold align-items-center">
          @if (groupBy !== 'date') {
            <div class="responsive-table-row employee-column">
              {{ 'REPORT_PAGE.DATE' | translate }}
            </div>
          }
          @if (groupBy !== 'employee' && groupBy !== 'project') {
            <div
              class="responsive-table-row employee-column"
              >
              {{ 'REPORT_PAGE.EMPLOYEE' | translate }}
            </div>
          }
          @if (groupBy !== 'employee' && groupBy === 'project') {
            <div
              class="responsive-table-row employee-column"
              >
              {{ 'REPORT_PAGE.PROJECT' | translate }}
            </div>
          }
          @if (groupBy !== 'project') {
            <div class="responsive-table-row project-column">
              {{ 'REPORT_PAGE.PROJECT' | translate }}
            </div>
          }
          <div class="responsive-table-row category-column">
            {{ 'REPORT_PAGE.CATEGORY' | translate }}
          </div>
          <div class="responsive-table-row description-column">
            {{ 'REPORT_PAGE.DESCRIPTION' | translate }}
          </div>
          <div class="responsive-table-row amount-column">
            {{ 'REPORT_PAGE.AMOUNT' | translate }}
          </div>
        </div>
      </div>
    }
  </ng-template>

  @if (dailyData?.length > 0) {
    @for (day of dailyData; track day) {
      <nb-card class="card">
        @switch (groupBy) {
          @case ('employee') {
            <ng-container *ngTemplateOutlet="groupByEmployeeCardEl; context: { $implicit: day }"></ng-container>
          }
          @case ('project') {
            <ng-container *ngTemplateOutlet="groupByProjectCardEl; context: { $implicit: day }"></ng-container>
          }
          @default {
            <ng-container *ngTemplateOutlet="groupByDateCardEl; context: { $implicit: day }"></ng-container>
          }
        }
      </nb-card>
    }
  } @else {
    <ngx-no-data-message [message]="'SM_TABLE.NO_DATA.EXPENSE' | translate"></ngx-no-data-message>
  }
</div>

<!-- Reusable template for expense row details (category, description, amount) -->
<ng-template #expenseRowDetailsEl let-expanseRow>
  <div class="responsive-table-row category-column">
    <div class="responsive-table-header">
      {{ 'REPORT_PAGE.CATEGORY' | translate }}
    </div>
    <div class="responsive-table-content project-name">
      @if (expanseRow?.category) {
        <span class="category-span">
          {{ expanseRow?.category?.name }}
        </span>
      } @else {
        —
      }
    </div>
  </div>
  <div class="responsive-table-row description-column">
    <div class="responsive-table-header">
      {{ 'REPORT_PAGE.DESCRIPTION' | translate }}
    </div>
    <div class="responsive-table-content project-name">
      @if (expanseRow?.purpose) {
        {{ expanseRow.purpose }}
      } @else {
        —
      }
    </div>
  </div>
  <div class="responsive-table-row amount-column">
    <div class="responsive-table-header">
      {{ 'REPORT_PAGE.AMOUNT' | translate }}
    </div>
    <div class="responsive-table-content project-name">
      {{ expanseRow?.amount | currency: expanseRow?.currency | position: organization?.currencyPosition }}
    </div>
  </div>
</ng-template>

<!-- Reusable template for project column -->
<ng-template #projectColumnEl let-projectRow let-expanseIndex="expanseIndex">
  <div class="responsive-table-row project-column">
    <div class="responsive-table-header">
      {{ 'REPORT_PAGE.PROJECT' | translate }}
    </div>
    <div class="responsive-table-content project-name">
      @if (expanseIndex == 0) {
        <ng-container *ngTemplateOutlet="projectEl; context: { $implicit: projectRow?.project }"></ng-container>
      }
    </div>
  </div>
</ng-template>

<ng-template let-day #groupByDateCardEl>
  <nb-card-header class="card-title">
    {{ day.date | dateFormat }}
  </nb-card-header>
  <nb-card-body class="expense-report-container">
    <ng-container *ngTemplateOutlet="columnsHeader"></ng-container>
    @for (employeeRow of day.employees; track employeeRow; let employeeIndex = $index) {
      <div class="cart-body project-row">
        @for (projectRow of employeeRow.projects; track projectRow; let projectIndex = $index) {
          <div class="table-row">
            @for (expanseRow of projectRow.expanse; track expanseRow; let expanseIndex = $index) {
              <div class="expanse-row">
                <div class="table-inner-wrapper">
                  @if (expanseIndex == 0 && projectIndex == 0) {
                    <div
                      class="responsive-table-row employee-column main-column-responsive responsive-heading-row"
                      >
                      <div class="responsive-table-header">
                        {{ 'REPORT_PAGE.EMPLOYEE' | translate }}
                      </div>
                      <div class="responsive-table-content employee">
                        <ng-container
                          *ngTemplateOutlet="employeeEl; context: { $implicit: employeeRow?.employee }"
                        ></ng-container>
                      </div>
                    </div>
                  } @else {
                    <div class="responsive-table-row employee-column no-height"></div>
                  }
                  <ng-container
							*ngTemplateOutlet="
								projectColumnEl;
								context: { $implicit: projectRow, expanseIndex: expanseIndex }
							"
                  ></ng-container>
                  <ng-container
                    *ngTemplateOutlet="expenseRowDetailsEl; context: { $implicit: expanseRow }"
                  ></ng-container>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </nb-card-body>
</ng-template>

<ng-template let-employee #groupByEmployeeCardEl>
  <nb-card-header class="card-title">
    <ng-container *ngTemplateOutlet="employeeEl; context: { $implicit: employee?.employee }"></ng-container>
  </nb-card-header>
  <nb-card-body>
    <ng-container *ngTemplateOutlet="columnsHeader"></ng-container>
    @for (dateRow of employee.dates; track dateRow; let dateIndex = $index) {
      <div class="cart-body project-row">
        @for (projectRow of dateRow.projects; track projectRow; let projectIndex = $index) {
          <div class="table-row">
            @for (expanseRow of projectRow.expanse; track expanseRow; let expanseIndex = $index) {
              <div
                class="expanse-row date-expanse-row"
                >
                <div class="table-inner-wrapper">
                  <div class="responsive-table-row employee-column responsive-heading-row">
                    <div class="responsive-table-header">
                      {{ 'REPORT_PAGE.DATE' | translate }}
                    </div>
                    <div class="responsive-table-content project-name">
                      {{ projectIndex == 0 && expanseIndex == 0 ? (dateRow.date | dateFormat) : '' }}
                    </div>
                  </div>
                  <ng-container
							*ngTemplateOutlet="
								projectColumnEl;
								context: { $implicit: projectRow, expanseIndex: expanseIndex }
							"
                  ></ng-container>
                  <ng-container
                    *ngTemplateOutlet="expenseRowDetailsEl; context: { $implicit: expanseRow }"
                  ></ng-container>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </nb-card-body>
</ng-template>

<ng-template let-project #groupByProjectCardEl>
  <nb-card-header class="card-title">
    <ng-container *ngTemplateOutlet="projectEl; context: { $implicit: project?.project }"> </ng-container>
  </nb-card-header>
  <nb-card-body>
    <ng-container *ngTemplateOutlet="columnsHeader"></ng-container>
    @for (dateRow of project.dates; track dateRow; let dateIndex = $index) {
      <div class="cart-body project-row">
        @for (employeeRow of dateRow.employees; track employeeRow; let employeeIndex = $index) {
          <div class="table-row">
            @for (expanseRow of employeeRow.expanse; track expanseRow; let expanseIndex = $index) {
              <div class="expanse-row">
                <div class="table-inner-wrapper">
                  @if (employeeIndex == 0 && expanseIndex == 0) {
                    <div
                      class="responsive-table-row project-column responsive-heading-row"
                      >
                      <div class="responsive-table-header">
                        {{ 'REPORT_PAGE.DATE' | translate }}
                      </div>
                      <div class="responsive-table-content project-name">
                        {{ dateRow.date | dateFormat }}
                      </div>
                    </div>
                  } @else {
                    <div class="responsive-table-row employee-column no-height"></div>
                  }
                  @if (expanseIndex == 0) {
                    <div
                      class="responsive-table-row employee-column main-column-responsive"
                      >
                      <div class="responsive-table-header">
                        {{ 'REPORT_PAGE.EMPLOYEE' | translate }}
                      </div>
                      <div class="responsive-table-content employee">
                        <ng-container
                          *ngTemplateOutlet="employeeEl; context: { $implicit: employeeRow?.employee }"
                          >
                        </ng-container>
                      </div>
                    </div>
                  } @else {
                    <div class="responsive-table-row employee-column no-height"></div>
                  }
                  <ng-container
                    *ngTemplateOutlet="expenseRowDetailsEl; context: { $implicit: expanseRow }"
                  ></ng-container>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </nb-card-body>
</ng-template>

<ng-template let-project #projectEl>
  @if (project) {
    <ga-project-column-view [project]="project"></ga-project-column-view>
  } @else {
    <span>{{ 'REPORT_PAGE.NO_PROJECT' | translate }}</span>
  }
</ng-template>

<ng-template let-client #clientEl>
  @if (client) {
    <span>
      <ngx-contact-links [value]="client"></ngx-contact-links>
    </span>
  } @else {
    <span>
      {{ 'REPORT_PAGE.NO_CLIENT' | translate }}
    </span>
  }
</ng-template>

<ng-template let-employee #employeeEl>
  <div class="avatar-wrapper-outer">
    @if (employee) {
      <ngx-avatar
        class="report-table"
        [src]="employee?.user?.imageUrl"
        [name]="employee?.user?.name"
        [id]="employee?.id"
        [employee]="employee"
      ></ngx-avatar>
    }
  </div>
  <ng-template #noEmployeeEl>
    <span>{{ 'REPORT_PAGE.NO_EMPLOYEE' | translate }}</span>
  </ng-template>
</ng-template>
