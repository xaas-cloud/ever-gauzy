<form #formDirective="ngForm" [formGroup]="form" (ngSubmit)="onSubmit()">
  <!-- Email input -->
  <div class="form-control-group">
    <label class="label" for="input-email">{{ 'LOGIN_PAGE.LABELS.EMAIL' | translate }}</label>
    <nb-form-field>
      <input
        type="email"
        name="input-email"
        id="input-email"
        nbInput
        fullWidth
        formControlName="email"
        [placeholder]="'LOGIN_PAGE.PLACEHOLDERS.EMAIL' | translate"
        [status]="email.dirty ? (email.invalid ? 'danger' : 'success') : 'basic'"
        [attr.aria-invalid]="email.invalid && email.touched ? true : null"
        [attr.autofocus]="isCodeSent ? true : null"
        autocomplete="email"
        [readonly]="isCodeSent"
        [ngClass]="isCodeSent ? 'not-allowed' : ''"
        />
        @if (isCodeSent && showEditEmailButton) {
          <nb-icon
            class="edit-email"
            nbSuffix
            nbButton
            size="small"
            ghost
            icon="edit-outline"
            (click)="onEditEmail()"
            nbTooltip="{{ 'WORKSPACES.EDIT_EMAIL' | translate }}"
            nbTooltipPosition="top"
          ></nb-icon>
        }
      </nb-form-field>
      @if (email.invalid && email.touched && !email.pristine) {
        @if (email?.errors?.required) {
          <p class="caption status-danger">
            {{ 'LOGIN_PAGE.VALIDATION.EMAIL_REQUIRED' | translate }}
          </p>
        }
        @if (email?.errors?.pattern) {
          <p class="caption status-danger">
            {{ 'LOGIN_PAGE.VALIDATION.EMAIL_REAL_REQUIRED' | translate }}
          </p>
        }
      }
    </div>

    <!-- Code input -->
    @if (isCodeSent) {
      <div class="sent-code-container">
        <p
				[ngClass]="{
					'normal-text': (email?.value?.length || 0) < 30,
					'minimum-text': (email?.value?.length || 0) >= 30
				}"
          >
          {{ successSentCodeTitle | translate }}
          <b class="title">{{ email?.value }}</b>
          <br />
          <span>{{ successSentCodeSubTitle | translate }}</span>
        </p>
      </div>
      <div class="form-control-group">
        <label class="label" for="input-code">{{ 'LOGIN_PAGE.LABELS.CODE' | translate }}</label>
        <input
          name="input-code"
          id="input-code"
          nbInput
          fullWidth
          formControlName="code"
          [placeholder]="'LOGIN_PAGE.PLACEHOLDERS.CODE' | translate"
          [status]="code.dirty ? (code.invalid ? 'danger' : 'success') : 'basic'"
          [attr.aria-invalid]="code.invalid && code.touched ? true : null"
          maxlength="6"
          [attr.autofocus]="isCodeSent ? true : null"
          autocomplete="one-time-code"
          inputmode="numeric"
          />
          @if (code.invalid && code.touched) {
            <div role="alert" aria-live="polite">
              @if (code.errors?.required) {
                <p class="caption status-danger">
                  {{ 'LOGIN_PAGE.VALIDATION.CODE_REQUIRED' | translate }}
                </p>
              }
              @if (code.errors?.minlength) {
                <p class="caption status-danger">
                  {{
                  'LOGIN_PAGE.VALIDATION.CODE_REQUIRED_LENGTH'
                  | translate : { requiredLength: code.errors?.minlength?.requiredLength }
                  }}
                </p>
              }
            </div>
          }
          <!-- Resend Code Button & Text -->
          <p class="new-code-wrapper">
            @if (isCodeResent) {
              <span class="request-new-code" role="status" aria-live="polite">
                {{ 'LOGIN_PAGE.LOGIN_MAGIC.REQUEST_NEW_CODE_TITLE' | translate : { countdown: countdown } }}
              </span>
            } @else {
              <a class="resend-code" (click)="onResendCode()">
                {{ 'LOGIN_PAGE.LOGIN_MAGIC.RESEND_CODE_TITLE' | translate }}
              </a>
            }
          </p>
        </div>
      }

      <!-- Submit Button -->
      <div class="submit-btn-wrapper">
        @if (showForgotEmailLink) {
          <a
            class="forgot-email caption-2 forgot-email-big"
            [href]="forgotEmailLink"
            target="_blank"
            rel="noopener noreferrer"
            >
            {{ 'LOGIN_PAGE.FORGOT_EMAIL_TITLE' | translate }}
          </a>
        }
        <div class="submit-inner-wrapper">
          @if (isCodeSent) {
            <button
              type="submit"
              nbButton
              size="tiny"
              class="submit-btn"
              [disabled]="form.invalid || isLoading"
              [attr.aria-busy]="isLoading ? true : null"
              [attr.aria-disabled]="form.invalid || isLoading ? true : null"
              >
              <span class="btn-text">
                {{ submitButtonText | translate }}
              </span>
              @if (isLoading) {
                <nb-icon
                  class="btn-icon"
                  [ngClass]="isLoading ? 'spinner' : ''"
                  icon="loader-outline"
                ></nb-icon>
              }
            </button>
          } @else {
            <button
              type="button"
              nbButton
              size="tiny"
              class="submit-btn"
              [disabled]="email.invalid || isLoading"
              (click)="onSendCode()"
              [attr.aria-busy]="isLoading ? true : null"
              [attr.aria-disabled]="email.invalid || isLoading ? true : null"
              >
              <span class="btn-text">
                {{ sendCodeButtonText | translate }}
              </span>
              @if (isLoading) {
                <nb-icon
                  class="btn-icon"
                  [ngClass]="isLoading ? 'spinner' : ''"
                  icon="loader-outline"
                ></nb-icon>
              }
            </button>
          }
        </div>
      </div>
    </form>
